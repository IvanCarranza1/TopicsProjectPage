<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="AdminLTE/plugins/fontawesome-free/css/all.min.css">
    <!-- pace-progress -->
    <link rel="stylesheet" href="AdminLTE/plugins/pace-progress/themes/black/pace-theme-flat-top.css">
    <!-- adminlte-->
    <link rel="stylesheet" href="AdminLTE/dist/css/adminlte.min.css">

   <!-- Dashboard style-->
    <link rel="stylesheet" href="css/dashBoardStyle.css">     
    <!-- Loader-->
    <link rel="stylesheet" href="css/loader.css">
</head>

<body class="hold-transition sidebar-mini" class="hold-transition sidebar-mini" onload="loadPage()" style="margin:0;">
  <div id="loader"></div>
  <div style="display:none;" id="contentView">
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="../../index3.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="#" class="nav-link">Contact</a>
        </li>
      </ul>
  
      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <!-- Notifications Dropdown Menu -->
        <li class="nav-item dropdown">
          <a class="nav-link" data-toggle="dropdown" href="#">
            <i class="far fa-bell"></i>
            <span class="badge badge-warning navbar-badge">15</span>
          </a>
          <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
            <span class="dropdown-item dropdown-header">15 Notifications</span>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item">
              <i class="fas fa-envelope mr-2"></i> 4 new messages
              <span class="float-right text-muted text-sm">3 mins</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item">
              <i class="fas fa-users mr-2"></i> 8 friend requests
              <span class="float-right text-muted text-sm">12 hours</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item">
              <i class="fas fa-file mr-2"></i> 3 new reports
              <span class="float-right text-muted text-sm">2 days</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
            <i class="fas fa-th-large"></i>
          </a>
        </li>
      </ul>
    </nav>
    <!-- /.navbar -->
  
    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-blue elevation-4">
     <!-- Brand Logo -->
     <a href="../home.html" class="brand-link">
      <span class="brand-text font-weight-light">Panel de administración</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="../dist/images/avatar.png" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info" id="EmployeeInfo" style="color: white;">
          Administador
        </div>
      </div>


      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
               <li class="nav-item">
                <a href="../home.html" class="nav-link active">
                    <i class="fas fa-map nav-icon"></i>
                  <p>
                    Home
                  </p>
                </a>
              </li>
               <li class="nav-item">
                <a href="sections/drivers_info.html" class="nav-link">
                    <i class="fas fa-clock nav-icon"></i>
                  <p>
                    Datos de rutas
                  </p>
                </a>
              </li>

            </li>
            <li class="nav-item">
             <a href="sections/admin_values.html" class="nav-link">
                 <i class="fas fa-wrench nav-icon"></i>
               <p>
                 Valores administrativos
               </p>
             </a>
           </li>

               <li class="nav-item">
                <a href="#" class="nav-link" onclick="signoutUser()">
                    <i class="fas fa-arrow-circle-left nav-icon"></i>
                  <p>
                    Cerrar sesión
                  </p>
                </a>
              </li>
         
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
    </aside>
  
      <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Main content -->
    <section class="content">
<!-- Default box -->
<div class="col-12">
  <div class="card">
    <div class="card-header p-2">
      <ul class="nav nav-pills">
        <li class="nav-item"><a class="nav-link active" href="#activity" data-toggle="tab">Ruta ida</a></li>
        <li class="nav-item"><a class="nav-link" href="#timeline" data-toggle="tab">Ruta retorno</a></li>
      </ul>
    </div><!-- /.card-header -->
    <div class="card-body">
      <div class="tab-content">
        <div class="active tab-pane" id="activity">
          <div class="card-body" id="map">
        </div>
      </div>

      <div class="active tab-pane" id="timeline">
        <div class="card-body" id="second_map">
      </div>
    </div>
      <!-- /.tab-content -->
    </div><!-- /.card-body -->
  </div>
  <!-- /.card -->
</div>
<!-- /.col -->
<!-- /.card -->

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  </div>
  <!-- ./wrapper -->
  </div>

<script src="dist/js/utils/initializeMap.js"></script>
<!-- jQuery -->
<script src="AdminLTE/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="AdminLTE/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="AdminLTE/dist/js/adminlte.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script src="dist/js/dbConnection.js"> </script>
<script src="dist/js/sections/home.js"> </script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-qMJWBuuBvjruLmhHiPXtZD3KtsgKA_Q&callback=initMap&libraries=&v=weekly" async>
</script>

<script>
  // counter for online cars...

// markers array to store all the markers, so that we could remove marker when any car goes offline and its data will be remove from realtime database...
var markers_first_map = [];
var markers_second_map = [];
var map;
var second_map;


function initMap() { // Google Map Initialization... 
  const gfg_office = {
            lat: 19.721185,
            lng: -101.185207
    };
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: gfg_office,
        mapTypeId: 'terrain',
        zoomControl: true,
        mapTypeControl: false,
        scaleControl: true,
        streetViewControl: false,
        rotateControl: false,
        fullscreenControl: true
    });

    second_map = new google.maps.Map(document.getElementById('second_map'), {
        zoom: 16,
        center: gfg_office,
        mapTypeId: 'terrain',
        zoomControl: true,
        mapTypeControl: false,
        scaleControl: true,
        streetViewControl: false,
        rotateControl: false,
        fullscreenControl: true
    });
    showPage()
}

// This Function will create a car icon with angle and add/display that marker on the map
function AddCarFirstSense(data) {

    var icon = { // car icon
        path: 'M29.395,0H17.636c-3.117,0-5.643,3.467-5.643,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759   c3.116,0,5.644-2.527,5.644-5.644V6.584C35.037,3.467,32.511,0,29.395,0z M34.05,14.188v11.665l-2.729,0.351v-4.806L34.05,14.188z    M32.618,10.773c-1.016,3.9-2.219,8.51-2.219,8.51H16.631l-2.222-8.51C14.41,10.773,23.293,7.755,32.618,10.773z M15.741,21.713   v4.492l-2.73-0.349V14.502L15.741,21.713z M13.011,37.938V27.579l2.73,0.343v8.196L13.011,37.938z M14.568,40.882l2.218-3.336   h13.771l2.219,3.336H14.568z M31.321,35.805v-7.872l2.729-0.355v10.048L31.321,35.805',
        scale: 1.0,
        fillColor: "#427af4", //<-- Car Color, you can change it 
        fillOpacity: 1,
        strokeWeight: 1,
        anchor: new google.maps.Point(0, 5),
        rotation: data.val().angle //<-- Car angle
    };

    var uluru = { lat: data.val().lat, lng: data.val().lng };

    var marker = new google.maps.Marker({
        position: uluru,
        icon: icon,
        map: map
    });

    var TST = new Date(data.val().time_start_travel)

var infowindow = new google.maps.InfoWindow({
    content:     
    '<div id="content">' +
    `</div>` +
    `<h5 id="firstHeading" class="firstHeading">Unidad ${data.val().unityID}</h5>` +
    `<p><Strong>Conductor:</Strong> ${data.val().driver_name}</p>`+
    `<p><Strong>Hora de inicio del viaje:</Strong> ${TST.getHours() + ":" + TST.getMinutes()}</p>`+
    `</div>` +
    `</div>`
              });
makeInfoWindowEvent(second_map, infowindow, marker);

    markers_first_map[data.key] = marker; // add marker in the markers array...
}

// This Function will create a car icon with angle and add/display that marker on the map
function AddCarSecondSense(data) {

var icon = { // car icon
    path: 'M29.395,0H17.636c-3.117,0-5.643,3.467-5.643,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759   c3.116,0,5.644-2.527,5.644-5.644V6.584C35.037,3.467,32.511,0,29.395,0z M34.05,14.188v11.665l-2.729,0.351v-4.806L34.05,14.188z    M32.618,10.773c-1.016,3.9-2.219,8.51-2.219,8.51H16.631l-2.222-8.51C14.41,10.773,23.293,7.755,32.618,10.773z M15.741,21.713   v4.492l-2.73-0.349V14.502L15.741,21.713z M13.011,37.938V27.579l2.73,0.343v8.196L13.011,37.938z M14.568,40.882l2.218-3.336   h13.771l2.219,3.336H14.568z M31.321,35.805v-7.872l2.729-0.355v10.048L31.321,35.805',
    scale: 1.0,
    fillColor: "#427af4", //<-- Car Color, you can change it 
    fillOpacity: 1,
    strokeWeight: 1,
    anchor: new google.maps.Point(0, 5),
    rotation: data.val().angle //<-- Car angle
};

var uluru = { lat: data.val().lat, lng: data.val().lng };

var marker = new google.maps.Marker({
    position: uluru,
    icon: icon,
    map: second_map
});

var TST = new Date(data.val().time_start_travel)

var infowindow = new google.maps.InfoWindow({
    content:     
    '<div id="content">' +
    `</div>` +
    `<h5 id="firstHeading" class="firstHeading">Unidad ${data.val().unityID}</h5>` +
    `<p><Strong>Conductor:</Strong> ${data.val().driver_name}</p>`+
    `<p><Strong>Hora de inicio del viaje:</Strong> ${TST.getHours() + ":" + TST.getMinutes()}</p>`+
    `</div>` +
    `</div>`
              });
makeInfoWindowEvent(second_map, infowindow, marker);

markers_second_map[data.key] = marker; // add marker in the markers array...
}

// get firebase database reference...
var cars_Ref_First_Sense = firebase.database().ref('/drivers_position/').orderByChild('travel_sense').equalTo(0);
var cars_Ref_Second_Sense = firebase.database().ref('/drivers_position/').orderByChild('travel_sense').equalTo(1);
   

// this event will be triggered when a new object will be added in the database...
cars_Ref_First_Sense.on('child_added', function (data) {
   console.log("AAAA")
    AddCarFirstSense(data);
});

// this event will be triggered on location change of any car...
cars_Ref_First_Sense.on('child_changed', function (data) {
  console.log("BBBB")
    markers_first_map[data.key].setMap(null);
    AddCarFirstSense(data);
});

// If any car goes offline then this event will get triggered and we'll remove the marker of that car...  
cars_Ref_First_Sense.on('child_removed', function (data) {
    console.log("CCC")
    markers_first_map[data.key].setMap(null);
});

// this event will be triggered when a new object will be added in the database...
cars_Ref_Second_Sense.on('child_added', function (data) {
   console.log("DDD")
    AddCarSecondSense(data);
});

// this event will be triggered on location change of any car...
cars_Ref_Second_Sense.on('child_changed', function (data) {
  console.log("EEE")
    markers_second_map[data.key].setMap(null);
    AddCarSecondSense(data);
});

// If any car goes offline then this event will get triggered and we'll remove the marker of that car...  
cars_Ref_Second_Sense.on('child_removed', function (data) {
    console.log("FFF")
    markers_second_map[data.key].setMap(null);
});

function makeInfoWindowEvent(map, infowindow, marker) {
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map, marker);
  });
}

</script>


</body>
</html>
